# ngroot
## Flexible and composable Seed Library for Asp.Net Applications

⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡾⠛⠳⣄⠀⣠⣤⣤⣄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣧⠘⣆⣿⠟⢹⠈⠁⣿⣇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⣠⣄⡀⠀⣠⣬⡓⡿⡏⠀⢸⠀⠀⡏⠸⣦⡴⣿⠛⣷⣦⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⢧⡐⣽⠟⠉⡟⠙⠃⡇⠀⠀⠀⠀⠀⠀⡽⠀⠀⠀⡏⣘⣿⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠉⢻⡇⠀⠃⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢰⠇⢸⠃⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⡟⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⣇⡴⠛⣿⣦⠀⠀⠀⠀⠀⠀⢀⡞⠙⣿⣦⠀⣿⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⡿⣷⣶⣿⣿⠀⠀⠀⠀⠀⠀⠘⣿⣶⣿⡿⠁⣿⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⡇⠈⠉⠉⠁⢰⣶⣶⣶⣶⣶⠀⠈⠉⠉⠀⣄⣿⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠻⣴⡀⠀⠀⠈⠛⠿⠭⠔⠋⠀⠀⠀⣄⣰⡿⠃⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⠛⠿⠷⠤⣶⣤⣤⣤⣤⡾⠾⠞⠋⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢠⡞⠳⣄⣀⣀⡴⢾⡷⣄⡇⢸⣿⢟⣲⣄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⠳⣤⣼⣟⣩⡽⣿⠁⢮⠳⣼⠟⠛⣦⢉⣧⣤⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠉⠉⠀⢠⡿⢤⡈⢧⡟⠀⠀⠈⠿⣤⡼⠇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⣷⠄⠙⠻⣇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣶⣶⣾⣷⣶⣶⣿⣿⣿⣶⣶⡆⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢹⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠃⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⠿⢿⣿⣿⣿⣿⣿⣿⡿⠿⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀


Seggregate your data into discreate, composable objects with full DI Support and agnostic to any ORM:

```C#
public class UsersLoader: ModelLoader<User>,
    IUsersLoader
{
    public UsersLoader(
        IOptions<NgrootSettings> settings,
        IUserRepository userRepository
    ) : base(settings)
    {
        Setup("Users")
        .FindDuplicatesWith(m => userRepository.FindByUserNameAsync(m.UserName))
        .CreateModelUsing(m => userRepository.CreateAsync(m))
    }
}
```

You can Express Relationships in your data conveniently via Fluent Interface too:
```C#
public class AssignedPermissionsLoader : ModelLoader<AssignedPermission>
{
    public AssignedPermissionsLoader(IFileLoader fileLoader, IOptions<NgrootSettings> settings, IAssignedPermissionsRepository assignedPermissionsRepository) : base(settings)
    {
        Setup("AssignedPermissions")
        .FindDuplicatesWith(m => assignedPermissionsRepository.GetByPermissionAndRoleAsync(m.PermissionId, m.RoleId))
        .CreateModelUsing(m => assignedPermissionsRepository.CreateAsync(m))
        .UseFileLoader()
        // Permission Map
        .With<Permission>("Permissions", m => m.PermissionId,
        permission => permission.Id,
        (permission, m) => m.Permission?.Name == permission.Name,
        (permission, m) => m.Permission = null)
        // Role Map
        .With<Role>("Roles", d => d.RoleId, s => s.Id,
        (role, m) => role.Name == m.Role?.Name,
        (role, m) => m.Role = null);
    }
}
```

The loader works loading a provided JSON file of your data. New data added to the file is automatically added to your database on application restart. Also, data can be reset by overriding found duplicates. This is very useful for integration testing and conditional data reset. Starting from version 2.0.0, it also provides InMemory Support.


```C#
public class UsersLoader: ModelLoader<User>,
    IUsersLoader
{
    public UsersLoader(
        IOptions<NgrootSettings> settings,
        IUserRepository userRepository
    ) : base(settings)
    {
        Setup("Users")
        .FindDuplicatesWith(m => userRepository.FindByUserNameAsync(m.UserName))
        .Load(() => 
        new User{
            UserName = "admin"
        },
        new User{
            UserName = "JohnDoe"
        }
        )
        .OverrideDuplicatesWith((model, duplicate) =>
        {
            /* ...
            Your Reset Logic
            */ ...
            return repository.EditAsync(duplicate);
        })
        .CreateModelUsing(m => userRepository.CreateAsync(m))
    }
}
```

Loaders work with a string Key, but can work just as easily with any key you prefer. By default it works with JSON files, but it can work with any file type you want, provided you override a FileLoader.

```C#
public class UsersLoader: ModelLoader<User, EntityEnum>,
    IUsersLoader
{
    public UsersLoader(
        IFileLoader fileLoader,
        IOptions<NgrootSettings> settings,
        IUserRepository userRepository
    ) : base(settings)
    {
        Setup(EntityEnum.Users)
        .FindDuplicatesWith(m => userRepository.FindByUserNameAsync(m.UserName))
        .CreateModelUsing(m => userRepository.CreateAsync(m))
        .UseFileLoader(fileLoader);
    }
}
```

Multiple extension points are located throughout the library, so you can pretty much override any of the default functionality at will.

## Setup

You can start working with NGroot in 4 Simple Steps!


1. Make sure to have a C# Class for the Model you want to save to your database and some code to do the Actual Creation! (This little nuisance is what makes NGroot Agnostic from any ORM). For example, if you have an entity named Package you can start with the following:

```C#
public class Package
{
    public int Id { get; set; }
    public string? Name { get; set; }
}
```

2. Create a Loader For your data. Here's an example using Entity Framework to Add your data. You must setup a loading source, either using the Load method to provide your data in memory, or UseFileLoader, to load it from a JsonFile:
```C#

using Microsoft.EntityFrameworkCore;
namespace ShipmentsApi;

public interface IPackagesLoader : IModelLoader
{ }
public class PackagesLoader : ModelLoader<Package, InitialData>, IPackagesLoader
{
    public PackagesLoader(IOptions<NgrootSettings<InitialData>> settings, ShipmentsContext context) : base(settings)
    {
        Setup(InitialData.Packages)
            .FindDuplicatesWith(m => context.Packages.FirstOrDefaultAsync(pck => pck.Name == m.Name))
            .Load(() => new Package{
                Name = "My wonderful package"
            })
            .CreateModelUsing(async (m) =>
            {
                context.Add(m);
                await context.SaveChangesAsync();
                return m;
            });
    }
}
```

3. Setup is very simple:
```C#
// On Program.cs
builder.Services.ConfigureNGroot<InitialData>(settings =>{}, typeof(Program).Assembly);
```

This will also automatically register your loaders on the provided assembly against dotnet DI container.

4. To Load your models, you must call an additional method to explicitly set the loading order of your data
```C#
await provider.LoadData<InitialData>(new Type[]
{
    typeof(ShipmentsLoader),
    typeof(PackagesLoader),
}, contentRootPath: app.Environment.ContentRootPath);
```

And Done!! Wasn't that easy? 


## Advanced Scenarios:

To Add File Support:
1. Add UseFileLoader, without arguments, to use the default json fileloader:
```C#

using Microsoft.EntityFrameworkCore;
namespace ShipmentsApi;

public interface IPackagesLoader : IModelLoader
{ }
public class PackagesLoader : ModelLoader<Package, InitialData>, IPackagesLoader
{
    public PackagesLoader(IOptions<NgrootSettings<InitialData>> settings, ShipmentsContext context) : base(settings)
    {
        Setup(InitialData.Packages)
            .FindDuplicatesWith(m => context.Packages.FirstOrDefaultAsync(pck => pck.Name == m.Name))
            .UseFileLoader()
            .CreateModelUsing(async (m) =>
            {
                context.Add(m);
                await context.SaveChangesAsync();
                return m;
            });
    }
}
```
You could also specify your own implementation to load any other kind of data (csv, xml, etc).

2. Add a json file in your project Directory:

Your file should look like this:
```jsonc
[
    {
        "Name": "My wonderful package!" // Your model should be a in JSON list format!
    }
]
```
3. You have a few different options to load your settings. Either adding an extra element to your appsettings, like this:

```jsonc
  "NGrootSettings": {
    "InitialDataFolderRelativePath": "InitialData/Data", // this is the root folder in your project directory where data will be located
    "SeedTestData": true,
    "PathConfiguration": [
      {
        "Identifier": "Packages",
        "RelativePath": "Packages.json" // this is the path for each specific file
      },
      {
        "Identifier": "Shipments",
        "RelativePath": "Shipments.json"
      }
    ]
  }
```

4. And binding the configuration manually or using NGroot configuration helpers:
```C#
// Configure Settings
var initialDataSettingsSection = builder.Configuration.GetSection("NGrootSettings");
builder.Services.Configure<NgrootSettings<InitialData>>(initialDataSettingsSection);
// Configure Loader
builder.Services.AddScoped<IPackagesLoader, PackagesLoader>();
```

or
```C#
// Configure Settings
builder.Services.ConfigureNGroot<InitialData>(builder.Configuration);

// Configure Loader
builder.Services.AddScoped<IPackagesLoader, PackagesLoader>();
```
Sadly, we still don't support automatic loader registration when loading from the appsettings.

You could bind the configuration from memory too:
```C#
// Configure Loader
builder.Services.ConfigureNGroot<InitialData>(settings =>
{
    settings.InitialDataFolderRelativePath = "InitialData/Data";
    settings.SeedTestData = true;
    settings.PathConfiguration = new List<BaseDataSettings<InitialData>>
    {
        new BaseDataSettings<InitialData>{ Identifier = InitialData.Packages, RelativePath = "Packages.json"},
        new BaseDataSettings<InitialData>{ Identifier = InitialData.Shipments, RelativePath = "Shipments.json"}
    };
}, typeof(Program).Assembly);

```

For early play, you can checkout the [Nuget Package](https://www.nuget.org/packages/NGroot/) and try it yourself. It's still unlisted, but will officialy be released soon.

You can also check out the [demo](https://github.com/carbonell/Shippings-Demo)
